# BACnet MSTP
## Profile for Wireshark Network Protocol Analyzer

**Revision 20.07** – Added Remove Trailing Pads filter button and color rule. Updated Bad Checksum, or Malformed Packets for filters, color, IO graph

**Revision 19.11** – Initial Release

Prepared By: David Purser

Contributors: Jeff Morton

July 2020

 
### 1	Description and Objective

This document summarizes the files and configuration of this Wireshark profile for use in analyzing BACnet MSTP Communications.

It is expected that installers know how to capture BACnet MSTP communication and use this document to learn how to use this profile to assist in analysis.

### 2	Files Included

Folder / Profile Name: **BACnet MSTP**

**colorfilters** – packet colorization. Edited by View -> Coloring Rules…

**dfilter_buttons** – display filter buttons. Edited by + beside Expression… toolbar

**io_graphs** – IO graph filters. Edited by Statistics -> IO Graphs

**preferences** – Wireshark preferences. Edited by Edit -> Preferences

Install profile folder in **%AppData%\Wireshark\profiles**

### 3	Files Excluded

These files can be excluded as they are not pre-configured and are regenerated by Wireshark.

**decode_as_entries** – dissector assignments. Edited by Analyze -> Decode As…

**recent** – recent GUI related settings. Read at program start and written at program exit.

### 4	Preferences

Preferences changed from default GUI profile:
* Packet List & Packet Details in side-by-side view
* Packet Bytes window disabled

### 5	Coloring Rules


|Color|	Name|
|---|---|
|Yellow| Poll for Master
|Orange|	Reply to Poll for Master
|Purple|	MSTP Broadcasts
|Blue|	Interface is Source
|Brown|	Reply Postponed
|Lt. Gray|	Trailing Pads
|Red|	Bad MSTP Checksum or Malformed Packets
|Green|	Proprietary Traffic

### 6	Display Filter Buttons

Can be edited in Edit -> Preferences -> Filter Buttons. One can add/remove, enable/disable, re-order, or clean up labels and comments

Enabled by default.
|Button Label|	Comment|
|---|---|
|Source MAC|	Packets from Source MAC address
|Destination MAC|	Packets from Destination MAC address
|Only Token Passing|	Token passing, Poll for Master, Poll for master responses
|Poll for Master|	Poll for Master
|Poll for Master Responses|	Poll for Master Responses
|Token Returned to Master|	Token returned to master
|Bad Packets|	Checksum Errors or Malformed Packets
|Broadcasts|	All broadcast packets
|Reply Postponed|	Unit too busy to answer immediately
|Proprietary Packets|	Proprietary Packets
|Bad Packets|	Checksum Errors or Malformed Packets
|Remote Trailing Pads|	1 byte padding at end of transmission categorized as malformed packet

Disabled by default.
|Button Label|	Comment|
|---|---|
|Exclude All Tokens|	Exclude token passing


### 7	IO Graphs

|Color|	Graph Name|
|---|---|
|Black|	All Token Passing
|Yellow|	Poll for Master
|Orange|	Reply to Poll for Master
|Purple|	MSTP Broadcasts
|Blue|	Interface is Source
|Brown|	Reply Postponed
|Green|	Proprietary Traffic
|Red|	Bad Checksum or Malformed Packets

### 8	Troubleshooting Scenarios

Poll for Master

Reply to Poll for Master

Token Returned to Master

Token packets are devices (source MAC) looking for next higher device (destination MAC) online up to Max Master before returning token to Master (MAC 0x00).
* Poll for Master can show offline devices, non-incremental MAC configuration, or Max Master set to high or default (127).
* Reply to Poll for Master can show devices previously offline that have come back online.
* Token Returned to Master can show token roundtrip time when reviewing period between token returned to master. If Enhanced Mode for b3 controllers, one can also see when b3 controllers return packet to master.

**Broadcasts**
These packets are broadcast to all devices. Review to find any issues

**Interface is Source**
These packets are generated from interface/master MAC 0x00. Review to find any issues.

**Reply Postponed**
Packets sent by device indicating it is busy to postpone sending expected reply.

**Proprietary Packets**
These packets may need to be reviewed to find any issues.

**Bad Checksum or Malformed Packets**
These packets either contain bad checksums or malformed packets. Investigate for devices with issues on communication port or wiring issues with electrical (EOL, biasing) or installation.
